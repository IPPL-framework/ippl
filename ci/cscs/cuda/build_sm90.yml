include:
  - local: "ci/cscs/common.yml"

variables:
  CUDA12_9_UENV: "/capstor/store/cscs/cscs/public/uenvs/opal-x-gh200-mpich-gcc-2025-12-19-cuda-12.9.1.squashfs"
  WITH_UENV_VIEW: "default"
  WRAPPER: "/user-environment/wrapper-mpi.sh"
  SCRATCH: "/capstor/scratch/cscs/biddisco"
  SRUN_FLAGS: "--uenv=${CUDA12_9_UENV};--view=${WITH_UENV_VIEW};--repo=$SCRATCH/.uenv-images-ci-daint;$WRAPPER"

# ---------------------------------------------------------
# Common settings for cuda builds
# this uses a uenv loaded by the uenv-runner and then cmake to build
# ---------------------------------------------------------
.ippl-build-cuda-common:
  stage: ippl_build
  extends: [.uenv-runner-daint-gh200]
  image: "${CUDA12_9_UENV}"
  variables:
    SLURM_JOB_NUM_NODES: 1
  before_script:
    - echo "CI_PROJECT_URL=$CI_PROJECT_URL"
    - echo "CI_COMMIT_SHORT_SHA=$CI_COMMIT_SHORT_SHA"
  script:
    - pwd
    - env | sort
    - >-
      if [ -n "$CI_MERGE_REQUEST_IID" ]; then
        echo "Running for MR !${CI_MERGE_REQUEST_IID}"
      else
        echo "Not a merge request pipeline"
      fi
      if [[ "$CI_COMMIT_REF_NAME" =~ pr([0-9]+) ]]; then
        PR_NUMBER="${BASH_REMATCH[1]}"
        echo "GitHub PR number: $PR_NUMBER"
      fi
    - mkdir "$BUILD_DIR"
    - cd "$BUILD_DIR"
    - >-
      cmake -S .. -B . -G Ninja
      --preset alps-gh200
      -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE}
      -DKokkos_VERSION=git.4.7.02
      -DKokkos_ARCH_HOPPER90=ON
      -DIPPL_ENABLE_SOLVERS=ON
      -DIPPL_MARK_FAILING_TESTS=ON
      -DCTEST_SITE="Daint GH200 CUDA 12.9.1"
      -DMPIEXEC_EXECUTABLE=/usr/bin/srun
      -DMPIEXEC_PREFLAGS="$SRUN_FLAGS"
      -DMPIEXEC_MAX_NUMPROCS=4
    - ninja all
    - echo "Build directory size (before cleanup):"
    - du -sh .
    - find . -name \*.o -delete
    - echo "Build directory size (cleaned for artefacts):"
    - du -sh .
  artifacts:
    paths:
      - $BUILD_DIR
    expire_in: 1 day

# ---------------------------------------------------------
# cuda build on daint gh200 with debug flags
# ---------------------------------------------------------
ippl-build-cuda12-sm90-debug:
  extends: .ippl-build-cuda-common
  variables:
    BUILD_DIR: "ippl-build-debug"
    CMAKE_BUILD_TYPE: Debug

# ---------------------------------------------------------
# cuda build on daint gh200 with release flags
# ---------------------------------------------------------
ippl-build-cuda12-sm90-release:
  extends: .ippl-build-cuda-common
  variables:
    BUILD_DIR: "ippl-build-release"
    CMAKE_BUILD_TYPE: Release
