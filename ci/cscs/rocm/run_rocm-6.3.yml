include:
  - local: "ci/cscs/common.yml"

variables:
  ROCM6_3_UENV: "prgenv-gnu/25.07-6.3.3:v12"
  WITH_UENV_VIEW: "default"
  F7T_CLIENT_ID: $F7T_TDS_CONSUMER_KEY
  F7T_CLIENT_SECRET: $F7T_TDS_CONSUMER_SECRET
  WRAPPER: "/users/biddisco/src/opal/ippl/scripts/landau/strong-scaling-alps/wrapper-mi300.sh"
  SCRATCH: "/capstor/scratch/cscs/biddisco"
  SRUN_ARGS: "--uenv=${ROCM6_3_UENV} --view=${WITH_UENV_VIEW} --repo=$SCRATCH/.uenv-images-ci-beverin $WRAPPER"

ippl-test-rocm6_3-debug-1-rank:
  stage: ippl_test
  needs: ["ippl-build-rocm6_3-debug"]
  extends: [.baremetal-runner-beverin-mi300]
  variables:
    BUILD_DIR: "ippl-build-debug"
    SLURM_JOB_NUM_NODES: 1
    SLURM_NTASKS: 1
    SLURM_CPUS_PER_TASK: 8
    SLURM_TIMELIMIT: "0:15:00"
  before_script:
    - pwd
    - date
    - ls -alh $BUILD_DIR/bin
    - ls -alh $BUILD_DIR/lib
  script:
    - cd $BUILD_DIR/
    - export LD_LIBRARY_PATH=$BUILD_DIR/lib:$LD_LIBRARY_PATH
    - ctest --output-on-failure --timeout 60 -E "known_fail"

ippl-test-rocm6_3-release-1-rank:
  stage: ippl_test
  needs: ["ippl-build-rocm6_3-release"]
  extends: [.baremetal-runner-beverin-mi300]
  variables:
    BUILD_DIR: "ippl-build-release"
    SLURM_JOB_NUM_NODES: 1
    SLURM_NTASKS: 1
    SLURM_CPUS_PER_TASK: 8
    SLURM_TIMELIMIT: "0:15:00"
  before_script:
    - pwd
    - date
    - ls -alh $BUILD_DIR/bin
    - ls -alh $BUILD_DIR/lib
  script:
    - cd $BUILD_DIR/
    - export LD_LIBRARY_PATH=$BUILD_DIR/lib:$LD_LIBRARY_PATH
    - ctest --output-on-failure --timeout 60 -E "known_fail"

ippl-test-rocm6_3-release-4-ranks:
  stage: ippl_test
  needs: ["ippl-build-rocm6_3-release"]
  extends: [.baremetal-runner-beverin-mi300]
  variables:
    BUILD_DIR: "ippl-build-release"
    SLURM_JOB_NUM_NODES: 1
    SLURM_NTASKS: 4
    SLURM_CPUS_PER_TASK: 8
    SLURM_TIMELIMIT: "0:30:00"
  before_script:
    - pwd
    - date
    - ls -alh $BUILD_DIR/bin
    - ls -alh $BUILD_DIR/lib
  script:
    - cd $BUILD_DIR/
    - export LD_LIBRARY_PATH=$BUILD_DIR/lib:$LD_LIBRARY_PATH
    - ctest --output-on-failure --timeout 60 -E "known_fail"

ippl-test-rocm6_3-release-failing-4-ranks:
  stage: ippl_test
  needs: ["ippl-build-rocm6_3-release"]
  extends: [.baremetal-runner-beverin-mi300]
  variables:
    BUILD_DIR: "ippl-build-release"
    SLURM_JOB_NUM_NODES: 1
    SLURM_NTASKS: 4
    SLURM_CPUS_PER_TASK: 8
    SLURM_TIMELIMIT: "0:30:00"
  before_script:
    - pwd
    - date
    - ls -alh $BUILD_DIR/bin
    - ls -alh $BUILD_DIR/lib
  script:
    - cd $BUILD_DIR/
    - export LD_LIBRARY_PATH=$BUILD_DIR/lib:$LD_LIBRARY_PATH
    - ctest --output-on-failure --timeout 60 -R "known_fail"
  allow_failure: true
