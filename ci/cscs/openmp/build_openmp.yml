include:
  - local: "ci/cscs/common.yml"

variables:
  EIGER_UENV: "prgenv-gnu/25.6:v2"
  WITH_UENV_VIEW: "default"
  SCRATCH: "/capstor/scratch/cscs/biddisco"
  SRUN_FLAGS: "--uenv=${EIGER_UENV};--view=${WITH_UENV_VIEW};--repo=$SCRATCH/.uenv-images-ci-eiger;$WRAPPER"
  BUILD_ARCH: "openmp"
  CTEST_SITE: "Eiger OpenMP"

# ---------------------------------------------------------
# Common settings for openmp builds
# this uses a uenv loaded by the uenv-runner and then cmake to build
# ---------------------------------------------------------
.ippl-build-openmp-common:
  stage: ippl_build
  extends: [.uenv-runner-eiger-zen2]
  image: "${EIGER_UENV}"
  variables:
    SLURM_JOB_NUM_NODES: 1
  before_script:
    - !reference [.pr-number-extractor, before_script]
    - export BUILD_PATH=$(pwd)/$BUILD_DIR
    - pwd
    - env | sort | grep CI
    - export CC=gcc
    - export CXX=g++
  script:
    - >-
      ctest -V -S $CI_PROJECT_DIR/ci/cscs/dashboard-configure-build.cmake 
      -DCTEST_SITE="$CTEST_SITE"
      -DPRESET=release-testing        
      -DPR_NUMBER=$PR_NUMBER                
      -DBUILD_TYPE=$BUILD_TYPE                 
      -DBUILD_DIR=$BUILD_PATH
      -DBUILD_ARCH=$BUILD_ARCH                
      -DIPPL_PLATFORMS=OPENMP
      -DIPPL_OPENMP_THREADS=32
      -DKokkos_VERSION=git.4.7.02           
      -DKokkos_ARCH_FLAG=Kokkos_ARCH_AMD_GFX942_APU 
      -DMPIEXEC_EXECUTABLE=/usr/bin/srun    
      -DMPIEXEC_PREFLAGS="$SRUN_FLAGS"      
      -DMPIEXEC_MAX_NUMPROCS=4
    - echo "Build directory size (before cleanup):" $(du -sh $BUILD_PATH | cut -f1)
    - find $BUILD_PATH -name \*.o -delete
    - echo "Build directory size (cleaned for artefacts):" $(du -sh $BUILD_PATH | cut -f1)
  artifacts:
    paths:
      - $BUILD_DIR
    expire_in: 1 day

# ---------------------------------------------------------
# openmp build debug
# ---------------------------------------------------------
ippl-build-openmp-debug:
  extends: .ippl-build-openmp-common
  variables:
    BUILD_DIR: "build-$CI_COMMIT_SHORT_SHA-debug"
    BUILD_TYPE: Debug

# ---------------------------------------------------------
# openmp build release
# ---------------------------------------------------------
ippl-build-openmp-release:
  extends: .ippl-build-openmp-common
  variables:
    BUILD_DIR: "build-$CI_COMMIT_SHORT_SHA-release"
    BUILD_TYPE: Release
